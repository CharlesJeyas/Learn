<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sentence Trainer</title>
<style>
  body {
    margin: 0; 
    font-family: Arial, sans-serif;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    padding: 10px;
  }
  #inputArea {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  textarea {
    width: 100%;
    height: 120px;
    font-size: 1rem;
    padding: 8px;
    resize: vertical;
  }
  #inputControls {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
    margin-top: 10px;
  }
  button, select {
    padding: 10px 15px;
    font-size: 1rem;
    cursor: pointer;
  }
  #playerUI {
    flex: 1;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 20px;
  }
  #textDisplay {
    display: none;
    max-width: 90%;
    margin-bottom: 20px;
  }
  #sentence {
    font-size: 1.5rem;
    margin-bottom: 10px;
  }
  #translation {
    font-size: 1.3rem;
    color: green;
  }
  #controls {
    display: none;
    flex-direction: column;
    align-items: center;
    padding-bottom: 20px;
  }
  #mainButtons, #navButtons {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 10px;
    margin: 5px 0;
  }
  #jumpButtons {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 5px;
  }
</style>
</head>
<body>

<div id="inputArea">
  <div>
    <h3>English Passage</h3>
    <textarea id="englishInput" placeholder="Enter English..."></textarea>
  </div>
  <div>
    <h3>Hebrew Passage</h3>
    <textarea id="hebrewInput" placeholder="Enter Hebrew..."></textarea>
  </div>

  <div id="inputControls">
    <select id="historySelect">
      <option value="">-- Load from history --</option>
    </select>
    <button id="clearHistoryBtn">Clear History</button>
    <button id="loadBtn">Load Sentences</button>
  </div>
</div>

<div id="playerUI">
  <div id="textDisplay">
    <div id="sentence"></div>
    <div id="translation"></div>
  </div>
</div>

<div id="controls">
  <div id="mainButtons">
    <button id="playEnglishBtn">‚ñ∂Ô∏è Play English</button>
    <button id="playHebrewBtn">‚ñ∂Ô∏è Play Hebrew</button>
    <button id="toggleTextBtn">Show Text</button>
    <button id="backBtn" style="background:#f44336; color:white;">üîÅ New Text</button>
  </div>

  <div id="navButtons">
    <button id="prevBtn">‚¨ÖÔ∏è Prev</button>
    <div id="jumpButtons"></div>
    <button id="nextBtn">Next ‚û°Ô∏è</button>
  </div>
</div>

<script>
  const englishInput = document.getElementById("englishInput");
  const hebrewInput = document.getElementById("hebrewInput");
  const loadBtn = document.getElementById("loadBtn");
  const inputArea = document.getElementById("inputArea");
  const playerUI = document.getElementById("playerUI");
  const textDisplay = document.getElementById("textDisplay");
  const sentenceDiv = document.getElementById("sentence");
  const translationDiv = document.getElementById("translation");
  const playEnglishBtn = document.getElementById("playEnglishBtn");
  const playHebrewBtn = document.getElementById("playHebrewBtn");
  const toggleTextBtn = document.getElementById("toggleTextBtn");
  const backBtn = document.getElementById("backBtn");
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");
  const controls = document.getElementById("controls");
  const jumpButtons = document.getElementById("jumpButtons");
  const historySelect = document.getElementById("historySelect");
  const clearHistoryBtn = document.getElementById("clearHistoryBtn");

  let sourceSentences = [], hebrewTranslations = [], currentIndex = 0, textVisible = false;
  let currentUtterance = null;
  let playingLang = null; // "en" or "he" or null

  function splitIntoSentences(text) {
    return text.match(/[^.!?]+[.!?]+|[^.!?]+$/g)?.map(s => s.trim()) || [];
  }

  function resetButtons() {
    playEnglishBtn.textContent = "‚ñ∂Ô∏è Play English";
    playHebrewBtn.textContent = "‚ñ∂Ô∏è Play Hebrew";
  }

  function speak(text, lang) {
    if (!('speechSynthesis' in window)) return alert("Speech not supported.");
    speechSynthesis.cancel();
    currentUtterance = new SpeechSynthesisUtterance(text);
    currentUtterance.lang = lang === "he" ? "he-IL" : "en-US";
    currentUtterance.rate = lang === "he" ? 0.7 : 1.0;

    currentUtterance.onend = () => {
      resetButtons();
      playingLang = null;
    };
    speechSynthesis.speak(currentUtterance);
    playingLang = lang;
    updatePlayButtons();
  }

  function updatePlayButtons() {
    if (playingLang === "en" && speechSynthesis.speaking && !speechSynthesis.paused) {
      playEnglishBtn.textContent = "‚è∏Ô∏è Pause English";
      playHebrewBtn.textContent = "‚ñ∂Ô∏è Play Hebrew";
    } else if (playingLang === "he" && speechSynthesis.speaking && !speechSynthesis.paused) {
      playHebrewBtn.textContent = "‚è∏Ô∏è Pause Hebrew";
      playEnglishBtn.textContent = "‚ñ∂Ô∏è Play English";
    } else if (playingLang === "en" && speechSynthesis.paused) {
      playEnglishBtn.textContent = "‚ñ∂Ô∏è Resume English";
      playHebrewBtn.textContent = "‚ñ∂Ô∏è Play Hebrew";
    } else if (playingLang === "he" && speechSynthesis.paused) {
      playHebrewBtn.textContent = "‚ñ∂Ô∏è Resume Hebrew";
      playEnglishBtn.textContent = "‚ñ∂Ô∏è Play English";
    } else {
      resetButtons();
    }
  }

  function toggleEnglish() {
    if (playingLang === "en") {
      if (speechSynthesis.paused) {
        speechSynthesis.resume();
      } else if (speechSynthesis.speaking) {
        speechSynthesis.pause();
      } else {
        speak(sourceSentences[currentIndex], "en");
      }
    } else {
      speechSynthesis.cancel();
      speak(sourceSentences[currentIndex], "en");
    }
    updatePlayButtons();
  }

  function toggleHebrew() {
    if (playingLang === "he") {
      if (speechSynthesis.paused) {
        speechSynthesis.resume();
      } else if (speechSynthesis.speaking) {
        speechSynthesis.pause();
      } else {
        speak(hebrewTranslations[currentIndex], "he");
      }
    } else {
      speechSynthesis.cancel();
      speak(hebrewTranslations[currentIndex], "he");
    }
    updatePlayButtons();
  }

  function updateUI() {
    prevBtn.disabled = currentIndex === 0;
    nextBtn.disabled = currentIndex >= sourceSentences.length - 1;

    [...jumpButtons.children].forEach((btn, i) => {
      btn.disabled = i === currentIndex;
    });

    if (textVisible) {
      sentenceDiv.textContent = sourceSentences[currentIndex];
      translationDiv.textContent = hebrewTranslations[currentIndex] || '';
      textDisplay.style.display = "block";
      toggleTextBtn.textContent = "Hide Text";
    } else {
      textDisplay.style.display = "none";
      toggleTextBtn.textContent = "Show Text";
    }
  }

  function renderJumpButtons() {
    jumpButtons.innerHTML = '';
    sourceSentences.forEach((_, i) => {
      const btn = document.createElement("button");
      btn.textContent = i + 1;
      btn.onclick = () => {
        currentIndex = i;
        textVisible = false;
        updateUI();
        speechSynthesis.cancel();
        currentUtterance = null;
        resetButtons();
        playingLang = null;
        // auto play original sentence (English)
        speak(sourceSentences[currentIndex], "en");
      };
      jumpButtons.appendChild(btn);
    });
  }

  function addToHistory(english, hebrew) {
    const existing = JSON.parse(localStorage.getItem("sentenceHistory") || "[]");
    if (!existing.some(item => item.english === english && item.hebrew === hebrew)) {
      existing.push({ english, hebrew });
      localStorage.setItem("sentenceHistory", JSON.stringify(existing));
    }
    renderHistory();
  }

  function renderHistory() {
    const existing = JSON.parse(localStorage.getItem("sentenceHistory") || "[]");
    historySelect.innerHTML = `<option value="">-- Load from history --</option>`;
    existing.forEach((entry, index) => {
      const option = document.createElement("option");
      option.value = index;
      option.textContent = (entry.english.slice(0, 50) + (entry.english.length > 50 ? "..." : ""));
      historySelect.appendChild(option);
    });
  }

  loadBtn.onclick = () => {
    const eText = englishInput.value.trim();
    const hText = hebrewInput.value.trim();
    if (!eText || !hText) return alert("Please enter both English and Hebrew text.");

    sourceSentences = splitIntoSentences(eText);
    hebrewTranslations = splitIntoSentences(hText);
    const len = Math.min(sourceSentences.length, hebrewTranslations.length);
    sourceSentences = sourceSentences.slice(0, len);
    hebrewTranslations = hebrewTranslations.slice(0, len);

    currentIndex = 0;
    textVisible = false;

    inputArea.style.display = "none";
    playerUI.style.display = "flex";
    controls.style.display = "flex";

    renderJumpButtons();
    updateUI();

    currentUtterance = null;
    resetButtons();
    playingLang = null;

    // auto play English on load
    speak(sourceSentences[currentIndex], "en");

    addToHistory(eText, hText);
  };

  playEnglishBtn.onclick = () => {
    toggleEnglish();
  };

  playHebrewBtn.onclick = () => {
    toggleHebrew();
  };

  toggleTextBtn.onclick = () => {
    textVisible = !textVisible;
    updateUI();
  };

  backBtn.onclick = () => {
    speechSynthesis.cancel();
    currentUtterance = null;
    resetButtons();
    playingLang = null;
    inputArea.style.display = "flex";
    playerUI.style.display = "none";
    controls.style.display = "none";
    textVisible = false;
  };

  prevBtn.onclick = () => {
    if (currentIndex > 0) {
      currentIndex--;
      textVisible = false;
      updateUI();
      speechSynthesis.cancel();
      currentUtterance = null;
      resetButtons();
      playingLang = null;
      speak(sourceSentences[currentIndex], "en");
    }
  };

  nextBtn.onclick = () => {
    if (currentIndex < sourceSentences.length - 1) {
      currentIndex++;
      textVisible = false;
      updateUI();
      speechSynthesis.cancel();
      currentUtterance = null;
      resetButtons();
      playingLang = null;
      speak(sourceSentences[currentIndex], "en");
    }
  };

  historySelect.onchange = () => {
    const val = historySelect.value;
    if (val === "") return;
    const existing = JSON.parse(localStorage.getItem("sentenceHistory") || "[]");
    const entry = existing[parseInt(val)];
    if (!entry) return;
    englishInput.value = entry.english;
    hebrewInput.value = entry.hebrew;
  };

  clearHistoryBtn.onclick = () => {
    if (confirm("Clear all history?")) {
      localStorage.removeItem("sentenceHistory");
      renderHistory();
      historySelect.value = "";
    }
  };

  // Initialize history on load
  renderHistory();
</script>

</body>
</html>
